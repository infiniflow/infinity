
statement ok
DROP TABLE IF EXISTS sqllogic_tensor_maxsim;

statement ok
CREATE TABLE sqllogic_tensor_maxsim (title VARCHAR, num INT, t TENSOR(FLOAT, 4), body VARCHAR);

statement ok
COPY sqllogic_tensor_maxsim FROM '/var/infinity/test_data/tensor_maxsim.csv' WITH (DELIMITER ',', FORMAT CSV);

query I
SELECT * FROM sqllogic_tensor_maxsim;
----
test00 2 [[0.1,0.2,0.3,-0.2],[0.3,-0.2,0.2,0.3]] this
test11 4 [[0.2,0.1,0.3,0.4]] tree
test22 6 [[0.3,0.2,-11.1,0.4],[0.4,0.3,0.2,-88.5],[0.1,-0.4,9.4,0.3]] tell off
test33 8 [[0.4,0.3,0.2,0.1]] that
test44 12 [[0.1,0.2,0.3,-0.2],[0.3,-0.2,0.2,0.3]] time off
test55 14 [[0.2,0.1,0.3,0.4],[-0.4,0.3,0.2,0.1],[0,0.2,-0.3,-0.2],[0.3,-0.2,0.2,0.3]] where
test66 16 [[0.3,0.2,0.1,0.4],[0.4,0.3,0.2,-88.5],[0.1,-0.4,9.4,0.3],[0.3,0.2,0.1,0.4],[0.4,0.3,0.2,-88.5],[0.1,-0.4,9.4,0.3]] on
test77 18 [[0.4,-0.3,0.2,0.1],[-0.4,0.3,0.2,0.1]] off

query T
EXPLAIN SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '') WHERE 10 > num;
----
PROJECT (3)
 - table index: #4
 - expressions: [title (#1), SCORE (#2) round 4]
-> MatchTensorScan (2)
   - table name: sqllogic_tensor_maxsim(default_db.sqllogic_tensor_maxsim)
   - table index: #1
   - MatchTensor expression: MATCH TENSOR (t, [[0,-10,0,0.7],[9.2,45.6,-55.8,3.5]], MAX_SIM)
   - Top N: 10
   - index filter: None
   - leftover filter: 10 > CAST(num (#0) AS BigInt)
   - output columns: [num, title, __score, __rowid]

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '');
----
test22 636.870100
test55 27.370000
test66 11.910000
test33 3.620000
test77 2.260000
test00 -5.190000
test44 -5.190000
test11 -9.660000

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', 'threshold=25');
----
test22 636.870100
test55 27.370000

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', '');
----
test22 636.870100
test55 27.370000
test66 11.910000
test33 3.620000
test77 2.260000
test00 -5.190000
test44 -5.190000
test11 -9.660000

# option top 2
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', 'topn=2');
----
test22 636.870100
test55 27.370000

# option top 2
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', 'topn=2');
----
test22 636.870100
test55 27.370000

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '') WHERE 10 > num;
----
test22 636.870100
test33 3.620000
test00 -5.190000
test11 -9.660000

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', '') WHERE 10 > num;
----
test22 636.870100
test33 3.620000
test00 -5.190000
test11 -9.660000

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'double', 'maxsim', '') WHERE 10 > num;
----
test22 636.870100
test33 3.620000
test00 -5.190000
test11 -9.660000

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0, -10, 0, 1], [9, 46, -56, 4]], 'float16', 'maxsim', '') WHERE 10 > num;
----
test22 639.400000
test33 3.700000
test00 -5.200000
test11 -9.400000

# two blocks
statement ok
COPY sqllogic_tensor_maxsim FROM '/var/infinity/test_data/tensor_maxsim.csv' WITH (DELIMITER ',', FORMAT CSV);

query T
EXPLAIN SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '') WHERE 10 > num;
----
PROJECT (3)
 - table index: #4
 - expressions: [title (#1), SCORE (#2) round 4]
-> MERGE MatchTensor (5)
   - table name: sqllogic_tensor_maxsim(default_db.sqllogic_tensor_maxsim)
   - table index: #1
   - MatchTensor expression: MATCH TENSOR (t, [[0,-10,0,0.7],[9.2,45.6,-55.8,3.5]], MAX_SIM)
   - Top N: 10
   - output columns: [num, title, __score, __rowid]
  -> MatchTensorScan (2)
     - table name: sqllogic_tensor_maxsim(default_db.sqllogic_tensor_maxsim)
     - table index: #1
     - MatchTensor expression: MATCH TENSOR (t, [[0,-10,0,0.7],[9.2,45.6,-55.8,3.5]], MAX_SIM)
     - Top N: 10
     - index filter: None
     - leftover filter: 10 > CAST(num (#0) AS BigInt)
     - output columns: [num, title, __score, __rowid]

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '');
----
test22 636.870100
test22 636.870100
test55 27.370000
test55 27.370000
test66 11.910000
test66 11.910000
test33 3.620000
test33 3.620000
test77 2.260000
test77 2.260000

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', '');
----
test22 636.870100
test22 636.870100
test55 27.370000
test55 27.370000
test66 11.910000
test66 11.910000
test33 3.620000
test33 3.620000
test77 2.260000
test77 2.260000

# filter, top 3
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', 'topn=3') WHERE 10 > num;
----
test22 636.870100
test22 636.870100
test33 3.620000

# filter, top 3
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', 'topn=3') WHERE 10 > num;
----
test22 636.870100
test22 636.870100
test33 3.620000

# Cleanup
statement ok
DROP TABLE sqllogic_tensor_maxsim;

statement ok
CREATE TABLE sqllogic_tensor_maxsim (title VARCHAR, num INT, t TENSOR(FLOAT16, 4), body VARCHAR);

statement ok
COPY sqllogic_tensor_maxsim FROM '/var/infinity/test_data/tensor_maxsim.csv' WITH (DELIMITER ',', FORMAT CSV);

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '');
----
test22 636.954100
test55 27.370200
test66 11.908300
test33 3.623500
test77 2.266200
test00 -5.195500
test44 -5.195500
test11 -9.664500

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float16', 'maxsim', '');
----
test22 637.092700
test55 27.372800
test66 11.906800
test33 3.620400
test77 2.260600
test00 -5.200100
test44 -5.200100
test11 -9.668100

# option top 2
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'bfloat16', 'maxsim', 'topn=2');
----
test22 636.375100
test55 27.335000

# option top 2
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'double', 'maxsim', 'topn=2');
----
test22 636.954100
test55 27.370200

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '') WHERE 10 > num;
----
test22 636.954100
test33 3.623500
test00 -5.195500
test11 -9.664500

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', '') WHERE 10 > num;
----
test22 636.954100
test33 3.623500
test00 -5.195500
test11 -9.664500

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'double', 'maxsim', '') WHERE 10 > num;
----
test22 636.954100
test33 3.623500
test00 -5.195500
test11 -9.664500

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0, -10, 0, 1], [9, 46, -56, 4]], 'float16', 'maxsim', '') WHERE 10 > num;
----
test22 639.484400
test33 3.703500
test00 -5.205400
test11 -9.404500

# two blocks
statement ok
COPY sqllogic_tensor_maxsim FROM '/var/infinity/test_data/tensor_maxsim.csv' WITH (DELIMITER ',', FORMAT CSV);

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '');
----
test22 636.954100
test22 636.954100
test55 27.370200
test55 27.370200
test66 11.908300
test66 11.908300
test33 3.623500
test33 3.623500
test77 2.266200
test77 2.266200

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', '');
----
test22 636.954100
test22 636.954100
test55 27.370200
test55 27.370200
test66 11.908300
test66 11.908300
test33 3.623500
test33 3.623500
test77 2.266200
test77 2.266200

# filter, top 3
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', 'topn=3') WHERE 10 > num;
----
test22 636.954100
test22 636.954100
test33 3.623500

# filter, top 3
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', 'topn=3') WHERE 10 > num;
----
test22 636.954100
test22 636.954100
test33 3.623500

# Cleanup
statement ok
DROP TABLE sqllogic_tensor_maxsim;

statement ok
CREATE TABLE sqllogic_tensor_maxsim (title VARCHAR, num INT, t TENSOR(BFLOAT16, 4), body VARCHAR);

statement ok
COPY sqllogic_tensor_maxsim FROM '/var/infinity/test_data/tensor_maxsim.csv' WITH (DELIMITER ',', FORMAT CSV);

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '');
----
test22 634.709200
test55 27.263100
test66 11.863500
test33 3.605900
test77 2.251200
test00 -5.169700
test44 -5.169700
test11 -9.622300

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float16', 'maxsim', '');
----
test22 634.847200
test55 27.265600
test66 11.862000
test33 3.602800
test77 2.245600
test00 -5.174300
test44 -5.174300
test11 -9.625900

# option top 2
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'bfloat16', 'maxsim', 'topn=2');
----
test22 634.132100
test55 27.228000

# option top 2
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'double', 'maxsim', 'topn=2');
----
test22 634.709200
test55 27.263100

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '') WHERE 10 > num;
----
test22 634.709200
test33 3.605900
test00 -5.169700
test11 -9.622300

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', '') WHERE 10 > num;
----
test22 634.709200
test33 3.605900
test00 -5.169700
test11 -9.622300

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'double', 'maxsim', '') WHERE 10 > num;
----
test22 634.709200
test33 3.605900
test00 -5.169700
test11 -9.622300

# filter
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0, -10, 0, 1], [9, 46, -56, 4]], 'float16', 'maxsim', '') WHERE 10 > num;
----
test22 637.230500
test33 3.685500
test00 -5.179700
test11 -9.363300

# two blocks
statement ok
COPY sqllogic_tensor_maxsim FROM '/var/infinity/test_data/tensor_maxsim.csv' WITH (DELIMITER ',', FORMAT CSV);

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', '');
----
test22 634.709200
test22 634.709200
test55 27.263100
test55 27.263100
test66 11.863500
test66 11.863500
test33 3.605900
test33 3.605900
test77 2.251200
test77 2.251200

# default top 10
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', '');
----
test22 634.709200
test22 634.709200
test55 27.263100
test55 27.263100
test66 11.863500
test66 11.863500
test33 3.605900
test33 3.605900
test77 2.251200
test77 2.251200

# filter, top 3
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'maxsim', 'topn=3') WHERE 10 > num;
----
test22 634.709200
test22 634.709200
test33 3.605900

# filter, top 3
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', 'topn=3', WHERE 10 > num);
----
test22 634.709200
test22 634.709200
test33 3.605900

# filter, top 3
query TR
SELECT title, ROUND(SCORE(), 4) FROM sqllogic_tensor_maxsim SEARCH MATCH TENSOR (t, [[0.0, -10.0, 0.0, 0.7], [9.2, 45.6, -55.8, 3.5]], 'float', 'maxsim', 'topn=3;threshold=10', WHERE 10 > num);
----
test22 634.709200
test22 634.709200

# Cleanup
statement ok
DROP TABLE sqllogic_tensor_maxsim;
