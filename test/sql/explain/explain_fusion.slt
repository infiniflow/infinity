
statement ok
DROP TABLE IF EXISTS explain_fusion;

statement ok
CREATE TABLE explain_fusion (title VARCHAR, body VARCHAR, num INT, vec EMBEDDING(FLOAT, 4), t TENSOR(FLOAT, 4));

query I
EXPLAIN SELECT title FROM explain_fusion SEARCH MATCH('body^5', 'harmful chemical', 'topn=3'), KNN(vec, [0.0, -10.0, 0.0, 0.7], 'float', 'l2', 3), FUSION('rrf') WHERE 10 > num;
----
PROJECT (5)
 - table index: #4
 - expressions: [title (#0)]
-> FUSION (4)
   - fusion: #FUSION('rrf', '')
   - output columns: [title, num, __score, __rowid]
  -> MATCH (2)
     - table name: explain_fusion(default_db.explain_fusion)
     - table index: #1
     - match expression: MATCH('body^5', 'harmful chemical', 'topn=3')
     - filter for secondary index: None
     - filter except secondary index: 10 > CAST(num (#1) AS BigInt)
     - output columns: [title, num, __score, __rowid]
  -> MERGE KNN (7)
     - table index: #5
     - output columns: [title, num, KNN(vec, Float32, L2, 3), __rowid]
    -> KNN SCAN (3)
       - table name: explain_fusion(default_db.explain_fusion)
       - table index: #5
       - embedding info: vec
         - element type: FLOAT32
         - dimension: 4
         - distance type: L2
         - query embedding: 0,-10,0,0.7
       - filter: 10 > CAST(num (#1) AS BigInt)
       - output columns: [title, num, KNN(vec, Float32, L2, 3), __rowid]

query I
EXPLAIN SELECT title FROM explain_fusion SEARCH MAXSIM(t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float') WHERE 10 > num;
----
PROJECT (3)
 - table index: #4
 - expressions: [title (#1)]
-> MERGE TensorMaxSim (5)
   - table name: explain_fusion(default_db.explain_fusion)
   - table index: #1
   - TensorMaxSimScan expression: TensorMaxSim(t, [[0,-10,0,0.7],[9.2,45.6,-55.8,3.5]])
   - Top N: 10
   - output columns: [num, title, __score, __rowid]
  -> TensorMaxSimScan (2)
     - table name: explain_fusion(default_db.explain_fusion)
     - table index: #1
     - TensorMaxSimScan expression: TensorMaxSim(t, [[0,-10,0,0.7],[9.2,45.6,-55.8,3.5]])
     - Top N: 10
     - filter for secondary index: None
     - filter except secondary index: 10 > CAST(num (#0) AS BigInt)
     - output columns: [num, title, __score, __rowid]

#query I
#EXPLAIN SELECT title FROM explain_fusion SEARCH MATCH('body^5', 'harmful chemical', 'topn=3'), MAXSIM(t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float', 'topn=10'), FUSION('rrf') WHERE 10 > num;
#----

#query I
#EXPLAIN SELECT title FROM explain_fusion SEARCH KNN(vec, [0.0, -10.0, 0.0, 0.7], 'float', 'l2', 3), MAXSIM(t, [0.0, -10.0, 0.0, 0.7, 9.2, 45.6, -55.8, 3.5], 'float'), FUSION('rrf') WHERE 10 > num;
#----

# Cleanup
statement ok
DROP TABLE explain_fusion;
